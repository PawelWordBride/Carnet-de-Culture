<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cat√©gorie - Carnet de Culture</title>

  <style>
    body{font-family:Arial,sans-serif;margin:0;background:#f7f9fc;color:#333;}
    header{background:#27374D;color:#fff;padding:18px 14px;text-align:center;}
    header h1{margin:0 0 8px;font-size:1.6rem;}
    header a{color:#DDE6ED;text-decoration:none;font-weight:700;}
    header a:hover{text-decoration:underline;}
    main{max-width:1000px;margin:0 auto;padding:24px 16px 60px;}

    .intro{
      background:#DDE6ED;border:1px solid rgba(39,55,77,.12);
      border-radius:18px;padding:18px;box-shadow:0 4px 14px rgba(0,0,0,.08);
      margin-bottom:18px;
    }
    .intro h2{margin:0 0 8px;color:#27374D;font-size:1.2rem;}
    .intro p{margin:0;color:#27374D;opacity:.9;line-height:1.4;}

    .bookshelf{
      position:relative;
      padding:18px 12px 10px;
      border-radius:18px;
      background:linear-gradient(180deg, rgba(82,109,130,.12), rgba(82,109,130,.05));
      border:1px solid rgba(39,55,77,.10);
      overflow:hidden;
    }
    .shelf{
      position:relative;
      padding:12px 10px 20px;
      margin-bottom:18px;
      border-radius:16px;
      background:rgba(221,230,237,.55);
      border:1px solid rgba(39,55,77,.08);
    }
    .shelf::after{
      content:"";
      position:absolute;left:10px;right:10px;bottom:6px;
      height:10px;border-radius:12px;
      background:linear-gradient(90deg, rgba(39,55,77,.22), rgba(39,55,77,.10));
    }
    .shelf-row{
      display:flex;align-items:flex-end;gap:12px;flex-wrap:wrap;
      padding:6px 8px 14px;
    }
    .book{
      width:110px;height:165px;border-radius:14px;border:1px solid rgba(39,55,77,.18);
      box-shadow:0 10px 18px rgba(0,0,0,.10);
      cursor:pointer;position:relative;padding:0;overflow:hidden;background:#526D82;
      transform:translateY(0);transition:transform .15s ease, box-shadow .15s ease;
    }
    .book:hover{transform:translateY(-6px);box-shadow:0 16px 28px rgba(0,0,0,.16);}
    .book img{width:100%;height:100%;object-fit:cover;display:block;}
    .book .book-overlay{
      position:absolute;left:0; right:0; bottom:0;
      padding:10px 10px;
      background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.65));
      color:#fff;
    }
    .book .book-name{font-weight:800;font-size:.9rem;line-height:1.1;margin:0;}
    .book .book-author{margin:4px 0 0;font-size:.78rem;opacity:.9;}

    /* ====== MODAL + FLIP ====== */
    .modal{position:fixed;inset:0;display:none;z-index:9999;}
    .modal.is-open{display:block;}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter: blur(2px);}
    .modal-panel{
      position:relative;z-index:1;
      width:min(920px, calc(100% - 24px));
      margin:12px auto;background:#fff;border-radius:18px;
      border:1px solid rgba(39,55,77,.12);
      box-shadow:0 18px 60px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modal-close{
      position:absolute;top:10px;right:10px;
      width:40px;height:40px;border-radius:12px;
      border:1px solid rgba(39,55,77,.14);background:#f7f9fc;
      cursor:pointer;font-size:1.1rem;
    }
    .modal-top{
      padding:18px 18px 10px;
      background:linear-gradient(180deg, rgba(221,230,237,.75), rgba(255,255,255,1));
      border-bottom:1px solid rgba(39,55,77,.10);
    }
    .modal-top h2{margin:0 0 4px;color:#27374D;}
    .modal-sub{margin:0;opacity:.9;color:#27374D;}
    .modal-author-link{color:#27374D;text-decoration:underline;font-weight:700;}
    .modal-category{
      display:inline-block;margin-top:6px;padding:6px 10px;border-radius:999px;
      font-size:.78rem;font-weight:700;letter-spacing:.02em;
      background:#526D82;color:#DDE6ED;opacity:.95;
    }
    .hint-flip{
      margin-top:10px;
      font-size:.9rem;
      opacity:.85;
      color:#27374D;
    }
    .flip-scene{perspective:1200px;padding:18px;}
    .flip-card{
      width:min(420px, 100%);
      height:620px;
      margin:0 auto;
      position:relative;
      transform-style:preserve-3d;
      transition:transform .6s ease;
      cursor:pointer;
    }
    .flip-card.is-flipped{transform:rotateY(180deg);}
    .flip-face{
      position:absolute;inset:0;backface-visibility:hidden;border-radius:18px;overflow:hidden;
      border:1px solid rgba(39,55,77,.12);box-shadow:0 10px 30px rgba(0,0,0,.12);
      background:#fff;
    }
    .flip-front img{width:100%;height:100%;object-fit:cover;display:block;}
    .flip-back{transform:rotateY(180deg);background:#ffffff;}
    .modal-back-content{padding:18px;height:100%;overflow:auto;}
    .modal-back-content h3{margin:0 0 10px;color:#27374D;}
    .modal-back-content p{margin:0 0 10px;line-height:1.55;color:#27374D;opacity:.92;}
    @media (max-width:520px){.flip-card{height:560px;}}
  </style>
</head>

<body>
  <header>
    <h1 id="pageTitle">üìö Cat√©gorie</h1>
    <nav><a href="../../livres.html">‚¨Ö Retour √† Livres</a></nav>
  </header>

  <main>
    <section class="intro">
      <h2 id="catTitle">Cat√©gorie</h2>
      <p id="catDesc">Tous les livres de cette cat√©gorie.</p>
    </section>

    <div id="bookshelf" class="bookshelf" aria-label="Biblioth√®que"></div>
  </main>

  <!-- MODAL -->
  <div class="modal" id="bookModal" aria-hidden="true">
    <div class="modal-backdrop" data-close="true"></div>

    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <button class="modal-close" type="button" aria-label="Fermer" data-close="true">‚úï</button>

      <div class="modal-top">
        <h2 id="modalTitle">Livre</h2>
        <p class="modal-sub">
          <a id="modalAuthorLink" class="modal-author-link" href="../../pages/livres/auteurs.html">Auteur</a>
        </p>
        <p class="modal-category" id="modalCategory"></p>
        <p class="hint-flip">Astuce : clique sur le livre pour voir le r√©sum√©.</p>
      </div>

      <div class="flip-scene">
        <div class="flip-card" id="flipCard" aria-label="Cliquer pour retourner le livre">
          <div class="flip-face flip-front">
            <img id="modalCover" src="" alt="Couverture du livre" />
          </div>

          <div class="flip-face flip-back">
            <div class="modal-back-content">
              <h3>R√©sum√©</h3>
              <div id="modalSummary"></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", async () => {

    // ==== Helpers ====
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function slugify(s){
      return String(s ?? "")
        .trim()
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, "_");
    }

    function summaryToHtml(summary){
      if (Array.isArray(summary)) return summary.map(p => `<p>${escapeHtml(p)}</p>`).join("");
      if (typeof summary === "string" && summary.trim()) return `<p>${escapeHtml(summary)}</p>`;
      return "<p>R√©sum√© non disponible.</p>";
    }

    function chunk(arr, size){
      const out = [];
      for (let i=0;i<arr.length;i+=size) out.push(arr.slice(i, i+size));
      return out;
    }

    // ==== Genre depuis URL ====
    const params = new URLSearchParams(location.search);
    const rawGenre = (params.get("genre") || "").trim();
    const genre = slugify(rawGenre);

    const GENRE_LABELS = {
      romance: "Romance",
      aventure: "Aventure",
      policier: "Policier",
      fantastique: "Fantastique",
      science_fiction: "Science-fiction",
      fantasy: "Fantasy",
      young_adult: "Young Adult",
      manga: "Manga",
      bd: "Bande dessin√©e",
      citations: "Citations",
      litterature: "Litt√©rature"
    };

    const label = GENRE_LABELS[genre] || "Cat√©gorie";
    document.title = `${label} - Carnet de Culture`;
    document.getElementById("pageTitle").textContent = `üìö ${label}`;
    document.getElementById("catTitle").textContent = label;
    document.getElementById("catDesc").textContent = genre
      ? `Tous les livres de la cat√©gorie "${label}".`
      : `Aucune cat√©gorie d√©tect√©e. V√©rifie le lien : categorie.html?genre=policier`;

    // ==== Charge JSON ====
    const bookshelf = document.getElementById("bookshelf");

    async function loadBooks(){
      // categorie.html est dans pages/livres/ -> ../../ vers la racine
      const res = await fetch("../../assets/data/livres.json", { cache: "no-store" });
      if (!res.ok) throw new Error("Impossible de charger ../../assets/data/livres.json");
      return await res.json();
    }

    // ==== Modal refs ====
    const modal = document.getElementById("bookModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalCategory = document.getElementById("modalCategory");
    const modalCover = document.getElementById("modalCover");
    const modalSummary = document.getElementById("modalSummary");
    const modalAuthorLink = document.getElementById("modalAuthorLink");
    const flipCard = document.getElementById("flipCard");

    function openModal(book){
      modalTitle.textContent = book.title || "Livre";
      modalAuthorLink.textContent = book.author || "Auteur";

      // authorUrl stock√© c√¥t√© racine dans ton JSON => on remonte ../../
      modalAuthorLink.href = book.authorUrl ? `../../${book.authorUrl}` : "../../pages/livres/auteurs.html";

      const bookGenre = slugify(book.genre || "");
      modalCategory.textContent = GENRE_LABELS[bookGenre] || (book.genre || "");

      // cover stock√© c√¥t√© racine dans ton JSON => on remonte ../../
      modalCover.src = book.cover ? `../../${book.cover}` : "";
      modalCover.alt = `Couverture ‚Äî ${book.title || "Livre"}`;

      modalSummary.innerHTML = summaryToHtml(book.summary);

      flipCard.classList.remove("is-flipped");
      modal.classList.add("is-open");
      modal.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }

    function closeModal(){
      modal.classList.remove("is-open");
      modal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }

    // clic sur le livre = flip (pas de bouton)
    flipCard.addEventListener("click", () => flipCard.classList.toggle("is-flipped"));

    // fermer
    modalAuthorLink.addEventListener("click", () => closeModal());
    modal.addEventListener("click", (e) => {
      if (e.target && e.target.dataset && e.target.dataset.close === "true") closeModal();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modal.classList.contains("is-open")) closeModal();
    });

    function renderLibrary(list){
      bookshelf.innerHTML = "";

      if(!list.length){
        bookshelf.innerHTML = `
          <div class="shelf">
            <div class="shelf-row">
              <p style="margin:0;color:#27374D;opacity:.9;padding:6px 8px 14px;">
                Aucun livre trouv√© pour cette cat√©gorie.
                <br><br>
                <strong>Astuce :</strong> V√©rifie que ton JSON contient <code>"genre": "${escapeHtml(genre)}"</code>
              </p>
            </div>
          </div>
        `;
        return;
      }

      const shelves = chunk(list, 10);
      shelves.forEach(shelfBooks => {
        const shelf = document.createElement("div");
        shelf.className = "shelf";

        const row = document.createElement("div");
        row.className = "shelf-row";

        shelfBooks.forEach(b => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "book";

          const coverSrc = b.cover ? `../../${b.cover}` : "";

btn.innerHTML = `
  <img src="${coverSrc}" alt="Couverture ‚Äî ${escapeHtml(b.title || "Livre")}">
`;
          btn.addEventListener("click", () => openModal(b));
          row.appendChild(btn);
        });

        shelf.appendChild(row);
        bookshelf.appendChild(shelf);
      });
    }

    // ==== Init ====
    try{
      const books = await loadBooks();

      // filtre strict (slug)
      const filtered = genre
        ? books.filter(b => slugify(b.genre || "") === genre)
        : books;

      renderLibrary(filtered);
    } catch(err){
      console.error(err);
      bookshelf.innerHTML = `
        <div class="shelf">
          <div class="shelf-row">
            <p style="margin:0;color:#27374D;opacity:.9;padding:6px 8px 14px;">
              Impossible de charger la biblioth√®que.
              <br>V√©rifie <strong>assets/data/livres.json</strong> et que tu lances via Live Server / GitHub Pages.
            </p>
          </div>
        </div>
      `;
    }
  });
  </script>
</body>
</html>
